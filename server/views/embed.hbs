<html lang="en">
   <head>
   <meta charset="utf-8">
   <title> Cyclopse </title>
   <!-- CSS --> 
   <link rel="stylesheet" href="../css/iframe.css" />
   <link rel="stylesheet" href="../css/material.css" />
   </head>
   <body>
      <!-- FRAME --> 
      <div style="position: relative;">
         <div id="cyclopse-overlay" class="embedlam-overlay">
               <div class="embedlam-spinner">
                  <div class="embedlam-loader"></div>
               </div>
            </div>
         <div id="cyclopse-youtube-player"></div>
      </div>
      <!-- CODE -->
      <script>
         
         function cyclopse_loader(){

            var tag, firstScriptTag, player, loop, quality, mute, rate, start, end, init, overlay, timer;
            var iOS = ( navigator.userAgent.match(/(iPad|iPhone|iPod)/g) ? true : false );

            // Options & Overlay
            loop = {{video.loop}};
            quality = "{{video.quality}}";
            autoplay = {{ video.autoplay }};
            mute =  {{ video.mute }};
            rate = {{ video.rate }};
            start = {{ video.start }};
            end = {{ video.end }};
            init = true; 
            overlay = document.getElementById('cyclopse-overlay');

            // Load YT Player API
            tag = document.createElement("script");          
            tag.src = (("http:" === document.location.protocol) ? "http:" : "https:") + "//www.youtube.com/iframe_api"; 
            firstScriptTag = document.getElementById('cyclopse-youtube-player');    
            firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);          
            
            // Main
            window.onYouTubeIframeAPIReady = function(){ loadPlayer(); }

            // Player instance
            function loadPlayer(){
               embdebug = player = new YT.Player('cyclopse-youtube-player', {
                  width: {{ video.width }},
                  height: {{ video.height }},
                  videoId: "{{video.videoId}}",
                  playerVars: {
                     'iv_load_policy':  {{ video.iv_load_policy }},
                     'controls' : {{video.controls}},
                     'disablekb': {{video.disablekb}},
                     'fs' : {{video.fs}},
                     'modestbranding' : {{video.modestbranding}},
                     'showinfo' : {{video.showinfo}}
                  },
                  events: {
                     onReady: onPlayerReady, 
                     onStateChange: onPlayerStateChange, 
                     onError: onPlayerError 
                  } 
               }); 
            }; 
      
            // Timing - setStop(), killStop(), getOffset()
            // See client/scripts/services/ytplayerAPI.js 
            function setStop(looping){
  
               var ms;
               
               (iOS && looping) ? ms = timeoutLength_IOS() : ms = timeoutLength();

               console.log('setting stop: ' + ms + ' START: '+ start + ' END: ' + end );
               timer = setTimeout(function(){
                   console.log('firing function');
                  (!loop) ? 
                    player.pauseVideo() : 
                    player.seekTo(start); 
                  
                  killStop(true);

               }, ms);
            };

            function killStop(looping){
              console.log('killing timer');
              clearTimeout(timer);
              (iOS && looping) ? setStop(looping) : false;
            }

            function timeoutLength(){
              var ms = Math.floor( (end - player.getCurrentTime()) * 1000 );

              if (rate == 0.5) return (ms * 2);
              if (rate == 1 ) return (ms);
              if (rate == 1.5) return Math.floor(ms * .66);

              return ms; 
            }

            function timeoutLength_IOS(){
              console.log('ios length');
              var ms = Math.floor( (end - start) * 1000 );
              if (rate == 0.5) return (ms * 2);
              if (rate == 1 ) return (ms);
              if (rate == 1.5) return Math.floor(ms * .66);
              return ms; 
            }

            // YT Player callbacks
            function onPlayerReady(){
              player.mute();
              
              if (!iOS){
                console.log('not ios');
                console.log('start: ' + start);
                player.seekTo(start);
                player.playVideo();
              } else {
                overlay.style.visibility = "hidden";
                autoplay = true;
              } 
            };

            function onPlayerStateChange(event){
               console.log('PLAYER STATE EVENT: ' + event.data)
               if (event.data === YT.PlayerState.PLAYING){
                  setStop();
                  if (init){
                    
                    (iOS) ? overlay.style.visibility = "visible" : false;
                    
                    init = false;
                    player.pauseVideo();
                    player.seekTo(start);
                    
                    (rate != 1) ? 
                      player.setPlaybackRate(rate) : 
                      false;
                    
                    (autoplay) ? 
                      player.playVideo() : 
                      player.pauseVideo();
                     
                    
                    setTimeout(function(){
                      overlay.style.visibility = "hidden";
                      
                      (!mute) ? 
                        player.unMute(): 
                        false;
                     
                    }, 250);
                  }
               } else {
                 killStop();
               }
            };
            function onPlayerError(){ console.error("Cyclop.se v YouTube.com: 0-1"); };
         };
         
         // Do it. 
         cyclopse_loader();

      </script>
   </body>
</html>